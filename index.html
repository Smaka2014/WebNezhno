<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Каталог Nezhno</title>

  <style>
    body {
      background: #232d36;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0 0 60px 0; /* нижний отступ, чтобы футер не перекрывал контент */
      box-sizing: border-box;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background: #182027;
      border-bottom: 1.5px solid #333b42;
      position: relative;
    }

    .logo {
      height: 32px;
    }

    .title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-left: 15px;
    }

    .search-bar {
      flex: 1;
      margin: 0 16px;
      display: flex;
    }

    .search-bar input {
      width: 100%;
      padding: 7px 14px;
      border-radius: 8px;
      border: none;
      background: #1b2229;
      color: #fff;
      font-size: 1rem;
    }

    .menu {
      font-size: 2rem;
      cursor: pointer;
      margin-left: 16px;
    }

    .menu-popup {
      position: absolute;
      top: 64px;
      right: 20px;
      background: #202931;
      border-radius: 10px;
      box-shadow: 0 2px 14px #00000020;
      z-index: 10;
      display: none;
      min-width: 160px;
    }

    .menu-popup.active { display: block; }

    .menu-popup-item {
      padding: 16px;
      cursor: pointer;
      font-size: 1rem;
      border-bottom: 1px solid #253040;
      display: flex;
      align-items: center;
      color: #fff;
    }

    .menu-popup-item:last-child { border-bottom: none; }

    .cart-count {
      color: #47ef85;
      font-weight: bold;
      margin-left: 5px;
    }

    .catalog {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 24px;
    }

    .product-card {
      background: #202931;
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 2px 14px #00000020;
    }

    .product-img {
      width: 92px;
      height: 120px;
      object-fit: contain;
      margin-bottom: 10px;
      background: #181d21;
      border-radius: 8px;
      box-shadow: 0 2px 6px #00000010;
    }

    .product-price {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .product-title {
      color: #a5fffa;
      text-transform: uppercase;
      font-size: .92rem;
      margin-bottom: 8px;
      text-align: center;
    }

    .add-btn {
      background: transparent;
      border: 1.5px solid #4151fc;
      color: #fff;
      border-radius: 8px;
      padding: 8px 20px;
      font-size: 1rem;
      margin-top: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .add-btn:hover { background: #4151fc; color: #fff; }

    /* Блок действий в карточке */
    .product-actions {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 32px;
    }

    .product-qty-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .product-qty-btn {
      background: #2e3640;
      color: #fff;
      border: none;
      width: 26px;
      height: 26px;
      border-radius: 6px;
      cursor: pointer;
    }

    .product-qty-text {
      min-width: 20px;
      text-align: center;
    }

    /* Кнопка перейти в корзину */
    .go-to-cart-btn {
      display: none;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 70px;
      background: #4151fc;
      color: #fff;
      padding: 16px 32px;
      border-radius: 14px;
      border: none;
      font-size: 1.18rem;
      z-index: 30;
      box-shadow: 0 7px 32px #101920b0;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 600;
    }

    .go-to-cart-btn.active { display: block; }

    /* Корзина */
    .cart-modal {
      display: none;
      position: fixed;
      top: 60px;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(20,25,30, 0.97);
      z-index: 20;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 80px;
    }

    .cart-modal.active { display: flex; }

    .cart-content {
      background: #232d36;
      border-radius: 18px;
      padding: 28px 24px;
      min-width: 300px;
      text-align: center;
      max-width: 90vw;
    }

    .cart-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 16px;
    }

    .cart-list {
      margin-bottom: 18px;
      max-height: 260px;
      overflow-y: auto;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      color: #fff;
      gap: 8px;
    }

    .cart-item-left {
      flex: 1;
      text-align: left;
      font-size: 0.95rem;
    }

    .cart-item-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .qty-btn {
      background: #2e3640;
      color: #fff;
      border: none;
      width: 26px;
      height: 26px;
      border-radius: 6px;
      cursor: pointer;
    }

    .qty-text {
      min-width: 20px;
      text-align: center;
    }

    .cart-empty {
      color: #aaa;
    }

    .cart-total {
      margin-top: 10px;
      font-weight: 600;
      text-align: right;
    }

    .close-cart {
      background: #2e3640;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 7px 16px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 6px;
      width: 100%;
    }

    .checkout-btn {
      background: #4151fc;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 10px;
      width: 100%;
    }

    /* Профиль - окно редактирования */
    .profile-modal {
      display: none;
      position: fixed;
      top: 60px;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(20,25,30, 0.97);
      z-index: 25;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 60px;
    }

    .profile-modal.active { display: flex; }

    .profile-content {
      background: #232d36;
      border-radius: 18px;
      padding: 32px 26px;
      min-width: 310px;
      max-width: 92vw;
      text-align: left;
    }

    .profile-title {
      font-size: 1.23rem;
      font-weight: bold;
      margin-bottom: 18px;
      text-align: center;
    }

    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .profile-form input,
    .profile-form select {
      box-sizing: border-box;
      background: #182027;
      color: #fff;
      border: 1.3px solid #313e4a;
      border-radius: 7px;
      padding: 10px 12px;
      font-size: 1rem;
      width: 100%;
    }

    .save-profile-btn,
    .close-profile-btn {
      margin-top: 10px;
      background: #4151fc;
      color: #fff;
      border-radius: 8px;
      padding: 9px 0;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      width: 100%;
    }

    .close-profile-btn {
      background: #2e3640;
      margin-top: 5px;
    }

    /* Футер с ссылкой на бота */
    .bot-link {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      padding: 14px;
      background: #1b232b;
      color: #6acecb;
      border-top: 1px solid #293038;
      font-size: .93rem;
      letter-spacing: 0.03em;
      z-index: 40;
    }

    .bot-link a {
      color: #6acecb;
      text-decoration: none;
    }

    .bot-link a:hover {
      text-decoration: underline;
    }

    /* Модалка подтверждения заказа */
    .confirm-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .confirm-backdrop.active {
      display: flex;
    }

    .confirm-modal {
      background: #232d36;
      border-radius: 16px;
      padding: 20px 18px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 24px #00000080;
      text-align: left;
      font-size: 0.98rem;
    }

    .confirm-text {
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .confirm-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn {
      padding: 7px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 0.98rem;
      font-weight: 500;
    }

    .btn-secondary {
      background: #2e3640;
      color: #fff;
    }

    .btn-primary {
      background: #4151fc;
      color: #fff;
    }
  </style>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>

<div class="header">
  <!-- При деплое поменяй путь к логотипу на публичный URL -->
  <img src="https://github.com/Smaka2014/WebNezhno/blob/main/img/logo.jpg?raw=true" alt="logo" class="logo">
  <span class="title">Каталог Nezhno</span>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Поиск по каталогу..."/>
  </div>

  <span class="menu" id="menuBtn">&#9776;</span>

  <div class="menu-popup" id="menuPopup">
    <div class="menu-popup-item" id="profileBtn">&#128100; Профиль</div>
    <div class="menu-popup-item" id="cartBtn">&#128722; Корзина <span class="cart-count" id="cartCount">(0)</span></div>
  </div>
</div>

<!-- Каталог -->
<div class="catalog" id="catalog"></div>

<!-- Кнопка Перейти в корзину -->
<button class="go-to-cart-btn" id="goToCartBtn">Перейти в корзину</button>

<!-- Модальное окно корзины -->
<div class="cart-modal" id="cartModal">
  <div class="cart-content">
    <div class="cart-title">Ваша корзина</div>
    <div class="cart-list" id="cartList"></div>
    <div class="cart-total" id="cartTotal"></div>
    <button class="checkout-btn" id="checkoutBtn">Оформить заказ</button>
    <button class="close-cart" id="closeCartBtn">Закрыть</button>
  </div>
</div>

<!-- Модальное окно профиля -->
<div class="profile-modal" id="profileModal">
  <div class="profile-content">
    <div class="profile-title">Настройки профиля</div>
    <form class="profile-form" id="profileForm">
      <input type="text" id="surname" placeholder="Фамилия">
      <input type="text" id="name" placeholder="Имя">
      <input type="text" id="patronymic" placeholder="Отчество">
      <input type="email" id="email" placeholder="Почта">
      <select id="country">
        <option value="">Выберите страну</option>
        <option value="Россия">Россия</option>
        <option value="Беларусь">Беларусь</option>
        <option value="Казахстан">Казахстан</option>
      </select>
      <select id="region">
        <option value="">Выберите регион</option>
        <option value="Москва">Москва</option>
        <option value="СПб">Санкт-Петербург</option>
      </select>
      <select id="city">
        <option value="">Выберите город/посёлок</option>
        <option value="Москва">Москва</option>
        <option value="Петербург">Петербург</option>
      </select>
      <button type="submit" class="save-profile-btn">Сохранить</button>
      <button type="button" class="close-profile-btn" id="closeProfileBtn">Закрыть</button>
    </form>
  </div>
</div>

<!-- Футер-ссылка на бота -->
<div class="bot-link">
  <a href="https://t.me/nezhnomasterskayabot" target="_blank">@nezhnomasterskayabot</a>
</div>

<!-- Модалка подтверждения отправки заказа -->
<div class="confirm-backdrop" id="confirmBackdrop">
  <div class="confirm-modal">
    <div class="confirm-text">
      Данный список товаров будет отправлен менеджеру для подтверждения заказа. Продолжить?
    </div>
    <div class="confirm-buttons">
      <button class="btn btn-secondary" id="confirmCancel">Отмена</button>
      <button class="btn btn-primary" id="confirmOk">Продолжить</button>
    </div>
  </div>
</div>

<script>
(() => {
  if (window._giveFreely_init) return;
  window._giveFreely_init = true;

  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  console.log("TG object:", tg);
  if (tg) tg.expand();

  const productsData = [
    {id: '1', img: 'https://static.insales.ru/images/collections/1/5375/391322351/medium_B_Complex.jpg', title: 'Свечка базовая 250мл', price: 2290},
    {id: '2', img: 'https://static.insales.ru/images/collections/1/5375/391323985/medium_BPC-157.jpg', title: 'Новогодний набор', price: 3390},
    {id: '3', img: 'https://static.insales.ru/images/collections/1/5375/391324194/medium_SJ-PP-332.jpg', title: 'Свечка 100мл', price: 1790},
  ];

  const catalog = document.getElementById('catalog');
  const searchInput = document.getElementById('searchInput');
  let cart = [];

  function getCartItem(id) { return cart.find(item => item.id === id); }

  function renderCatalog(products) {
    if (!catalog) return;
    catalog.innerHTML = '';
    products.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img class="product-img" src="${product.img}" alt="${product.title}">
        <div class="product-price">${product.price} ₽</div>
        <div class="product-title">${product.title}</div>
        <div class="product-actions" data-id="${product.id}"></div>
      `;
      catalog.appendChild(card);
      updateProductActions(product.id);
    });
  }

  function updateProductActions(productId) {
    if (!catalog) return;
    const container = catalog.querySelector(`.product-actions[data-id="${productId}"]`);
    if (!container) return;
    const item = getCartItem(productId);
    if (!item) {
      container.innerHTML = `<button class="add-btn" data-id="${productId}">+ Добавить</button>`;
      const btn = container.querySelector('.add-btn');
      if (btn) btn.onclick = () => addToCart(productId);
    } else {
      container.innerHTML = `
        <div class="product-qty-controls">
          <button class="product-qty-btn" data-id="${productId}" data-action="minus">-</button>
          <span class="product-qty-text">${item.qty}</span>
          <button class="product-qty-btn" data-id="${productId}" data-action="plus">+</button>
        </div>
      `;
      container.querySelectorAll('.product-qty-btn').forEach(btn => {
        btn.onclick = () => {
          const action = btn.getAttribute('data-action');
          changeQty(productId, action);
        };
      });
    }
  }

  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const value = this.value.toLowerCase();
      const filtered = productsData.filter(p => p.title.toLowerCase().includes(value));
      renderCatalog(filtered);
    });
  }

  // элементы корзины (проверяем наличие в DOM перед использованием)
  const cartBtn = document.getElementById('cartBtn');
  const cartCount = document.getElementById('cartCount');
  const cartModal = document.getElementById('cartModal');
  const cartList = document.getElementById('cartList');
  const cartTotalEl = document.getElementById('cartTotal');
  const closeCartBtn = document.getElementById('closeCartBtn');
  const goToCartBtn = document.getElementById('goToCartBtn');
  const checkoutBtn = document.getElementById('checkoutBtn');

  function addToCart(id) {
    const product = productsData.find(p => p.id === id);
    if (!product) return;
    const found = cart.find(item => item.id === id);
    if (found) found.qty += 1;
    else cart.push({...product, qty: 1});
    updateCartUI();
    updateProductActions(id);
  }

  function updateCartUI() {
    if (!cartCount) return;
    const totalQty = cart.reduce((a, b) => a + b.qty, 0);
    cartCount.textContent = `(${totalQty})`;
    if (goToCartBtn) {
      if (totalQty > 0) goToCartBtn.classList.add('active');
      else goToCartBtn.classList.remove('active');
    }
  }

  if (cartBtn) cartBtn.onclick = openCartModal;
  if (goToCartBtn) goToCartBtn.onclick = openCartModal;

  function openCartModal() {
    if (cartModal) cartModal.classList.add('active');
    redrawCartModal();
  }

  function redrawCartModal() {
    if (!cartList) return;
    cartList.innerHTML = '';
    if (!cart.length) {
      cartList.innerHTML = '<div class="cart-empty">Корзина пуста</div>';
      if (cartTotalEl) cartTotalEl.textContent = '';
      return;
    }
    let totalPrice = 0;
    cart.forEach(item => {
      totalPrice += item.price * item.qty;
      const row = document.createElement('div');
      row.className = 'cart-item';
      row.innerHTML = `
        <div class="cart-item-left">${item.title}</div>
        <div class="cart-item-controls">
          <button class="qty-btn" data-id="${item.id}" data-action="minus">-</button>
          <span class="qty-text">${item.qty}</span>
          <button class="qty-btn" data-id="${item.id}" data-action="plus">+</button>
        </div>
      `;
      cartList.appendChild(row);
    });
    if (cartTotalEl) cartTotalEl.textContent = 'Итого: ' + totalPrice + ' ₽';
    cartList.querySelectorAll('.qty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        changeQty(id, action);
      });
    });
  }

  function changeQty(id, action) {
    const item = cart.find(i => i.id === id);
    if (!item) return;
    if (action === 'plus') item.qty += 1;
    else if (action === 'minus') {
      item.qty -= 1;
      if (item.qty <= 0) cart = cart.filter(i => i.id !== id);
    }
    updateCartUI();
    redrawCartModal();
    updateProductActions(id);
  }

  if (closeCartBtn) closeCartBtn.onclick = () => cartModal && cartModal.classList.remove('active');

  // меню, профиль, подтверждение и отправка
  const menuBtn = document.getElementById('menuBtn');
  const menuPopup = document.getElementById('menuPopup');
  let menuOpen = false;
  if (menuBtn) menuBtn.onclick = () => {
    menuOpen = !menuOpen;
    if (menuOpen) menuPopup && menuPopup.classList.add('active');
    else menuPopup && menuPopup.classList.remove('active');
  };
  document.addEventListener('click', (e) => {
    if (menuBtn && menuPopup && !menuBtn.contains(e.target) && !menuPopup.contains(e.target)) {
      menuPopup.classList.remove('active'); menuOpen = false;
    }
  });

  const profileModal = document.getElementById('profileModal');
  const profileBtn = document.getElementById('profileBtn');
  const closeProfileBtn = document.getElementById('closeProfileBtn');
  const profileForm = document.getElementById('profileForm');
  if (profileBtn) profileBtn.onclick = () => {
    profileModal && profileModal.classList.add('active');
    menuPopup && menuPopup.classList.remove('active');
    menuOpen = false;
    const data = JSON.parse(localStorage.getItem('profileData') || '{}');
    if (profileForm) {
      profileForm.surname.value = data.surname || '';
      profileForm.name.value = data.name || '';
      profileForm.patronymic.value = data.patronymic || '';
      profileForm.email.value = data.email || '';
      profileForm.country.value = data.country || '';
      profileForm.region.value = data.region || '';
      profileForm.city.value = data.city || '';
    }
  };
  if (closeProfileBtn) closeProfileBtn.onclick = () => profileModal && profileModal.classList.remove('active');
  if (profileForm) profileForm.onsubmit = function(e) {
    e.preventDefault();
    const formData = {
      surname: this.surname.value, name: this.name.value, patronymic: this.patronymic.value,
      email: this.email.value, country: this.country.value, region: this.region.value, city: this.city.value
    };
    localStorage.setItem('profileData', JSON.stringify(formData));
    alert('Профиль сохранён!');
    profileModal && profileModal.classList.remove('active');
  };

  const confirmBackdrop = document.getElementById('confirmBackdrop');
  const confirmCancel = document.getElementById('confirmCancel');
  const confirmOk = document.getElementById('confirmOk');
  if (confirmCancel) confirmCancel.addEventListener('click', () => confirmBackdrop && confirmBackdrop.classList.remove('active'));
  if (confirmOk) confirmOk.addEventListener('click', () => { confirmBackdrop && confirmBackdrop.classList.remove('active'); sendOrderToBot(); });
  if (checkoutBtn) checkoutBtn.addEventListener('click', () => { if (!cart.length) return; confirmBackdrop && confirmBackdrop.classList.add('active'); });

  function sendOrderToBot() {
    if (!cart.length) return;
    let total = 0;
    const itemsForSend = cart.map(item => {
      total += item.price * item.qty;
      return { id: item.id, name: item.title, price: item.price, qty: item.qty };
    });
    const payload = { items: itemsForSend, total: total };
    console.log("sendOrderToBot called, payload:", payload);
    console.log("tg in sendOrderToBot:", tg, "has sendData:", tg && typeof tg.sendData);
    if (tg && typeof tg.sendData === 'function') {
      tg.sendData(JSON.stringify(payload));
      console.log("tg.sendData called");

    }
  }

  // стартовый рендер
  renderCatalog(productsData);
  updateCartUI();

})();
</script>

</body>
</html>


